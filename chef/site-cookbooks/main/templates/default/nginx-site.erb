# Generated by Chef, do not edit

<%- site_dir = node[:skeleton][:site_dir] -%>
<%- log_dir = node[:skeleton][:log_dir] -%>
<%- server_names = node[:skeleton][:server_names] -%>
server {

    listen                80;
    server_name           <%= server_names.join(" ") %>;
    root                  <%= site_dir %>;
    access_log            <%= log_dir %>/access.log json;
    error_log             <%= log_dir %>/error.log;

    <%- if node[:skeleton][:htpasswd] -%>
    auth_basic            "Restricted";
    auth_basic_user_file  "<%= site_dir %>/../.htpasswd";
    <%- end -%>

    location ~ /(\.|Vagrantfile|chef|protected) {
        # Protect code files
        return 444;
    }

    <%- if node[:skeleton][:blocked_keywords] -%>
    location ~* (<%= node[:skeleton][:blocked_keywords].join("|") %>) {
        return 444;
    }
    <%- end -%>

    location ~ \.(css|gif|jpeg|jpg|js|png)$ {
        # Serve the file if it exists
    }

    location ~ \.php$ {
        try_files         $uri = 404;
        include           fastcgi_params;
        fastcgi_pass      127.0.0.1:9000;
        fastcgi_index     index.php;
        fastcgi_param     SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }

    location / {
        index             index.html index.php;
        try_files         $uri $uri/ /index.php?$args;
    }
}

<%- if node[:skeleton][:enable_check_servername] -%>
server {
    listen                80 default;
    server_name           _;
    return                301 http://<%= server_names[0] %>$1;
}
<%- end -%>
